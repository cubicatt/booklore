package com.adityachandel.booklore.service.email;

import com.adityachandel.booklore.exception.ApiError;
import com.adityachandel.booklore.model.dto.request.SendBookByEmailRequest;
import com.adityachandel.booklore.model.entity.BookEntity;
import com.adityachandel.booklore.model.entity.EmailProviderEntity;
import com.adityachandel.booklore.model.entity.EmailRecipientEntity;
import com.adityachandel.booklore.model.websocket.Topic;
import com.adityachandel.booklore.repository.BookRepository;
import com.adityachandel.booklore.repository.EmailProviderRepository;
import com.adityachandel.booklore.repository.EmailRecipientRepository;
import com.adityachandel.booklore.service.NotificationService;
import com.adityachandel.booklore.util.FileUtils;
import jakarta.mail.MessagingException;
import jakarta.mail.internet.MimeMessage;
import lombok.AllArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.mail.javamail.JavaMailSenderImpl;
import org.springframework.mail.javamail.MimeMessageHelper;
import org.springframework.stereotype.Service;

import java.io.File;
import java.util.Properties;

import static com.adityachandel.booklore.model.websocket.LogNotification.createLogNotification;

@Slf4j
@Service
@AllArgsConstructor
public class EmailService {

    private final EmailProviderRepository emailProviderRepository;
    private final BookRepository bookRepository;
    private final EmailRecipientRepository emailRecipientRepository;
    private final NotificationService notificationService;

    public void emailBookQuick(Long bookId) {
        BookEntity book = bookRepository.findById(bookId).orElseThrow(() -> ApiError.BOOK_NOT_FOUND.createException(bookId));
        EmailProviderEntity defaultEmailProvider = emailProviderRepository.findDefaultEmailProvider().orElseThrow(ApiError.DEFAULT_EMAIL_PROVIDER_NOT_FOUND::createException);
        EmailRecipientEntity defaultEmailRecipient = emailRecipientRepository.findDefaultEmailRecipient().orElseThrow(ApiError.DEFAULT_EMAIL_RECIPIENT_NOT_FOUND::createException);

        sendEmailInVirtualThread(defaultEmailProvider, defaultEmailRecipient.getEmail(), book);
    }

    public void emailBook(SendBookByEmailRequest request) {
        EmailProviderEntity emailProvider = emailProviderRepository.findById(request.getProviderId()).orElseThrow(() -> ApiError.EMAIL_PROVIDER_NOT_FOUND.createException(request.getProviderId()));
        BookEntity book = bookRepository.findById(request.getBookId()).orElseThrow(() -> ApiError.BOOK_NOT_FOUND.createException(request.getBookId()));
        EmailRecipientEntity emailRecipient = emailRecipientRepository.findById(request.getRecipientId()).orElseThrow(() -> ApiError.EMAIL_RECIPIENT_NOT_FOUND.createException(request.getRecipientId()));

        sendEmailInVirtualThread(emailProvider, emailRecipient.getEmail(), book);
    }

    private void sendEmailInVirtualThread(EmailProviderEntity emailProvider, String recipientEmail, BookEntity book) {
        String bookTitle = book.getMetadata().getTitle();
        String logMessage = "Email dispatch initiated for book: " + bookTitle + " to " + recipientEmail;
        notificationService.sendMessage(Topic.LOG, createLogNotification(logMessage));
        log.info(logMessage);

        Thread.startVirtualThread(() -> {
            try {
                sendEmail(emailProvider, recipientEmail, book);
                String successMessage = "The book: " + bookTitle + " has been successfully sent to " + recipientEmail;
                notificationService.sendMessage(Topic.LOG, createLogNotification(successMessage));
                log.info(successMessage);
            } catch (Exception e) {
                String errorMessage = "An error occurred while sending the book: " + bookTitle + " to " + recipientEmail + ". Error: " + e.getMessage();
                notificationService.sendMessage(Topic.LOG, createLogNotification(errorMessage));
                log.error(errorMessage, e);
            }
        });
    }

    private void sendEmail(EmailProviderEntity emailProvider, String recipientEmail, BookEntity book) throws MessagingException {
        JavaMailSenderImpl dynamicMailSender = setupMailSender(emailProvider);
        MimeMessage message = dynamicMailSender.createMimeMessage();
        MimeMessageHelper helper = new MimeMessageHelper(message, true);
        helper.setFrom(StringUtils.firstNonEmpty(emailProvider.getFromAddress(), emailProvider.getUsername()));
        helper.setTo(recipientEmail);
        helper.setSubject("Your Book from Booklore: " + book.getMetadata().getTitle());
        helper.setText(generateEmailBody(book.getMetadata().getTitle()));
        File bookFile = new File(FileUtils.getBookFullPath(book));
        helper.addAttachment(bookFile.getName(), bookFile);
        dynamicMailSender.send(message);
        log.info("Book sent successfully to {}", recipientEmail);
    }

    /**
     * Enhanced email sender configuration with SSL support and extended timeouts
     * Supports both STARTTLS (port 587) and SSL (port 465) connections
     * Includes extended timeouts for slow SMTP servers (e.g., cPanel)
     */
    private JavaMailSenderImpl setupMailSender(EmailProviderEntity emailProvider) {
        JavaMailSenderImpl dynamicMailSender = new JavaMailSenderImpl();
        dynamicMailSender.setHost(emailProvider.getHost());
        dynamicMailSender.setPort(emailProvider.getPort());
        dynamicMailSender.setUsername(emailProvider.getUsername());
        dynamicMailSender.setPassword(emailProvider.getPassword());

        Properties mailProps = dynamicMailSender.getJavaMailProperties();
        mailProps.put("mail.smtp.auth", emailProvider.isAuth());
        
        // Determine connection type and configure accordingly
        ConnectionType connectionType = determineConnectionType(emailProvider);
        configureConnectionType(mailProps, connectionType, emailProvider);
        
        // Enhanced timeout configuration for slow SMTP servers
        configureTimeouts(mailProps);
        
        // Enable debug mode for troubleshooting (can be controlled via environment variable)
        String debugMode = System.getProperty("mail.debug", "false");
        mailProps.put("mail.debug", debugMode);
        
        log.info("Email configuration: Host={}, Port={}, Type={}, Timeouts=60s", 
                 emailProvider.getHost(), emailProvider.getPort(), connectionType);

        return dynamicMailSender;
    }

    /**
     * Determines the connection type based on port and email provider settings
     */
    private ConnectionType determineConnectionType(EmailProviderEntity emailProvider) {
        // Check if SSL is explicitly enabled via ssl_enable field
        if (emailProvider.getSslEnable() != null && emailProvider.getSslEnable()) {
            return ConnectionType.SSL;
        }
        
        // Auto-detect based on port
        if (emailProvider.getPort() == 465) {
            return ConnectionType.SSL;
        } else if (emailProvider.getPort() == 587 && emailProvider.isStartTls()) {
            return ConnectionType.STARTTLS;
        } else if (emailProvider.isStartTls()) {
            return ConnectionType.STARTTLS;
        } else {
            return ConnectionType.PLAIN;
        }
    }

    /**
     * Configures mail properties based on connection type
     */
    private void configureConnectionType(Properties mailProps, ConnectionType connectionType, EmailProviderEntity emailProvider) {
        switch (connectionType) {
            case SSL -> {
                // SSL Configuration (typically port 465)
                mailProps.put("mail.transport.protocol", "smtps");
                mailProps.put("mail.smtp.ssl.enable", "true");
                mailProps.put("mail.smtp.ssl.trust", emailProvider.getHost());
                mailProps.put("mail.smtp.starttls.enable", "false");
                mailProps.put("mail.smtp.ssl.protocols", "TLSv1.2,TLSv1.3");
                mailProps.put("mail.smtp.ssl.checkserveridentity", "false");
                
                // Additional SSL properties for better compatibility
                mailProps.put("mail.smtp.ssl.socketFactory.class", "javax.net.ssl.SSLSocketFactory");
                mailProps.put("mail.smtp.ssl.socketFactory.fallback", "false");
                
                log.debug("Configured SSL email for {}:{}", emailProvider.getHost(), emailProvider.getPort());
            }
            case STARTTLS -> {
                // STARTTLS Configuration (typically port 587)
                mailProps.put("mail.transport.protocol", "smtp");
                mailProps.put("mail.smtp.starttls.enable", "true");
                mailProps.put("mail.smtp.starttls.required", "true");
                mailProps.put("mail.smtp.ssl.enable", "false");
                
                log.debug("Configured STARTTLS email for {}:{}", emailProvider.getHost(), emailProvider.getPort());
            }
            case PLAIN -> {
                // Plain SMTP Configuration (typically port 25)
                mailProps.put("mail.transport.protocol", "smtp");
                mailProps.put("mail.smtp.starttls.enable", "false");
                mailProps.put("mail.smtp.ssl.enable", "false");
                
                log.debug("Configured plain SMTP for {}:{}", emailProvider.getHost(), emailProvider.getPort());
            }
        }
    }

    /**
     * Configures extended timeouts for slow SMTP servers
     * Previous timeout values (15 seconds) were too short for many SMTP servers,
     * especially cPanel and other shared hosting providers
     */
    private void configureTimeouts(Properties mailProps) {
        // Extended timeout values (60 seconds) for better compatibility with slow SMTP servers
        // These values can be overridden via system properties if needed
        
        String connectionTimeout = System.getProperty("mail.smtp.connectiontimeout", "60000");
        String socketTimeout = System.getProperty("mail.smtp.timeout", "60000"); 
        String writeTimeout = System.getProperty("mail.smtp.writetimeout", "60000");
        
        mailProps.put("mail.smtp.connectiontimeout", connectionTimeout);  // 60 seconds (was 15)
        mailProps.put("mail.smtp.timeout", socketTimeout);                // 60 seconds (was 15)
        mailProps.put("mail.smtp.writetimeout", writeTimeout);            // 60 seconds (new)
        
        log.debug("Configured email timeouts: connection={}, socket={}, write={}", 
                  connectionTimeout, socketTimeout, writeTimeout);
    }

    private String generateEmailBody(String bookTitle) {
        return String.format("""
                Hello,
                
                You have received a book from Booklore. Please find the attached file titled '%s' for your reading pleasure.
                
                Thank you for using Booklore! We hope you enjoy your book.
                """, bookTitle);
    }

    /**
     * Enum representing different email connection types
     */
    private enum ConnectionType {
        SSL,        // Secure connection from start (typically port 465)
        STARTTLS,   // Start plain, upgrade to secure (typically port 587)
        PLAIN       // Plain SMTP connection (typically port 25)
    }
}
